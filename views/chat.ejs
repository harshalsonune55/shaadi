<script>
  const IS_SUBSCRIBED = <%= isSubscribed ? "true" : "false" %>;
</script>

<%- layout("layouts/navbar") %>

<div class="max-w-3xl mx-auto p-4">
  <h2 class="text-xl font-semibold mb-4">
    Chat with <%= receiverProfile.first_name %> <%= receiverProfile.last_name %>
  </h2>
  <!-- CHAT TIMER -->
  <% if (!isSubscribed) { %>
    <div
      id="chatTimer"
      class="mb-3 flex items-center justify-center gap-2
             bg-pink-50 border border-pink-200
             text-pink-700 font-semibold
             rounded-lg py-2 text-sm"
    >
      ‚è≥ Free chat ends in
      <span id="timerText" class="font-bold">24:00:00</span>
    </div>
  <% } %>


  <div id="messages" class="h-96 overflow-y-auto border rounded p-3 mb-3 bg-white">
    <% messages.forEach(msg => { %>
      <div class="<%= msg.senderPhone === user.phone ? 'text-right' : 'text-left' %> mb-2">
        <div class="inline-block max-w-[80%]">
          <span class="block px-3 py-2 rounded-lg 
            <%= msg.senderPhone === user.phone ? 'bg-pink-500 text-white' : 'bg-gray-200' %>">
            <%- msg.message.replace(
  /(\/call\/[a-zA-Z0-9]+)/g,
  '<a href="$1" class="text-blue-600 underline font-semibold">Join Call</a>'
) %>

          </span>
        
          <span class="block text-[10px] mt-1 text-gray-400
            <%= msg.senderPhone === user.phone ? 'text-right' : 'text-left' %>">
            <%= new Date(msg.createdAt).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit'
            }) %>
          </span>
        </div>
        
      </div>
    <% }) %>
  </div>

  <form id="chatForm" class="flex gap-2">
    <input type="hidden" id="receiverId" value="<%= receiverProfile._id %>">
    <input
  id="msgInput"
  class="flex-1 border rounded px-3 py-2"
  placeholder="Type a message..."
  autocomplete="off"
  inputmode="text"
/>

    <button type="submit" class="bg-pink-600 text-white px-4 rounded hover:bg-pink-700 transition">Send</button>
  </form>
</div>

<script>
  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const msgInput = document.getElementById("msgInput");
  const receiverId = "<%= receiverProfile._id %>"; // Ensure this is correctly rendered
  const receiverPhone = "<%= receiverPhone %>";
  const myPhone = "<%= user.phone %>"; // Added your own phone to re-join room

  const scrollToBottom = () => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };
  scrollToBottom();

  // Helper function to add bubbles to the UI
  function appendMessage(text, side) {
  const div = document.createElement("div");
  div.className = side === 'right' ? "text-right mb-3" : "text-left mb-3";

  const color = side === 'right'
    ? "bg-pink-500 text-white"
    : "bg-gray-200";

  const time = new Date().toLocaleTimeString([], {
    hour: '2-digit',
    minute: '2-digit'
  });

  div.innerHTML = `
    <div class="inline-block max-w-[80%]">
      <span class="block px-3 py-2 rounded-lg ${color}">
        ${text}
      </span>
      <span class="block text-[10px] mt-1 text-gray-400 ${
        side === 'right' ? 'text-right' : 'text-left'
      }">
        ${time}
      </span>
    </div>
  `;

  messagesDiv.appendChild(div);
  scrollToBottom();
}


  // logic for setting up the socket listener
  function setupSocket() {
    console.log("üü¢ Setting up chat listener...");

    // 1. Ensure we are in our own room to receive messages
    window.socket.emit("join user room", myPhone);

    // 2. Remove old listeners and set up new one
    window.socket.off("receive message");
    window.socket.on("receive message", (data) => {
      
      
      // Use == to ignore string/number differences
      if (data.senderPhone == receiverPhone) {
        appendMessage(data.message, 'left');
      } else {
        console.log("Ignoring message from another user:", data.senderPhone);
      }
    });
  }

  // Wait for the global socket to be ready
  if (window.socket && window.socket.connected) {
    setupSocket();
  } else {
    console.log("‚è≥ Socket not ready, waiting for connection...");
    // If the socket connects later, trigger setup
    document.addEventListener("DOMContentLoaded", () => {
       let checkInterval = setInterval(() => {
         if (window.socket && window.socket.id) {
           setupSocket();
           clearInterval(checkInterval);
         }
       }, 500);
    });
  }

  // HANDLE SENDING
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = msgInput.value.trim();
    if (!message) return;

    msgInput.value = ""; 

    try {
      const response = await fetch("/api/messages/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ receiverId, message })
      });

      const result = await response.json();
      if (result.success) {
        appendMessage(message, 'right');
      }
    } catch (err) {
      console.error("Fetch Error:", err);
    }
  });
</script>
<script>
  // ‚ùå Block typing numbers, numpad, @
  msgInput.addEventListener("keydown", (e) => {
    // Allow control keys
    const allowedKeys = [
      "Backspace", "Delete", "ArrowLeft", "ArrowRight",
      "ArrowUp", "ArrowDown", "Tab", "Enter", "Escape"
    ];
    if (allowedKeys.includes(e.key)) return;

    // Block digits (top row)
    if (e.key >= "0" && e.key <= "9") {
      e.preventDefault();
      return;
    }

    // Block numpad digits
    if (e.code.startsWith("Numpad")) {
      e.preventDefault();
      return;
    }

    // Block @ symbol
    if (e.key === "@") {
      e.preventDefault();
      return;
    }
  });

  // ‚ùå Block paste if contains phone or email
  msgInput.addEventListener("paste", (e) => {
    const pastedText = (e.clipboardData || window.clipboardData)
      .getData("text");

    if (containsPhoneOrEmail(pastedText)) {
      e.preventDefault();
      alert("‚ùå Sharing phone numbers or email addresses is not allowed.");
    }
  });

  // ‚ùå FINAL check before sending (MOST IMPORTANT)
  chatForm.addEventListener("submit", (e) => {
    const message = msgInput.value.trim();

    if (containsPhoneOrEmail(message)) {
      e.preventDefault();
      alert("‚ùå Phone numbers and email addresses are not allowed.");
      msgInput.value = "";
      return false;
    }
  });

  // üîç Detect phone numbers & emails
  function containsPhoneOrEmail(text) {
    const phoneRegex = /\b\d{6,}\b/; // blocks long digit sequences
    const emailRegex =
      /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;

    return phoneRegex.test(text) || emailRegex.test(text);
  }
</script>
<script>
  // ===============================
  // 1 DAY CHAT LIMIT + UI TIMER
  // ===============================
  if (!IS_SUBSCRIBED) {
  const CHAT_LIMIT_MS = 24 * 60 * 60 * 1000; // 1 day
  const chatKey = `chat_start_${receiverId}`;

  const sendBtn = chatForm.querySelector('button[type="submit"]');
  const timerText = document.getElementById("timerText");
  const chatTimer = document.getElementById("chatTimer");

  function lockChat() {
    msgInput.disabled = true;
    msgInput.classList.add("bg-gray-100", "cursor-not-allowed");
    msgInput.placeholder = "Chat locked. Subscribe to continue...";
    sendBtn.disabled = true;
    sendBtn.classList.add("opacity-60", "cursor-not-allowed");
  }

  function showModal() {
    if (typeof modal !== "undefined") {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  }

  // üîê Ensure correct start time
  function getStartTime() {
    let saved = localStorage.getItem(chatKey);

    if (!saved) {
      saved = Date.now();
      localStorage.setItem(chatKey, saved);
    }

    return parseInt(saved, 10);
  }

  // ‚è± Format as HH:MM:SS
  function formatTime(ms) {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
    const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
    const seconds = String(totalSeconds % 60).padStart(2, "0");
    return `${hours}:${minutes}:${seconds}`;
  }

  function startTimer() {
    const start = getStartTime();

    const interval = setInterval(() => {
      const elapsed = Date.now() - start;
      const remaining = CHAT_LIMIT_MS - elapsed;

      if (remaining <= 0) {
        timerText.textContent = "00:00:00";
        chatTimer.classList.remove("bg-pink-50", "text-pink-700");
        chatTimer.classList.add("bg-red-100", "text-red-700");

        clearInterval(interval);
        lockChat();
        showModal();
        return;
      }

      timerText.textContent = formatTime(remaining);

      // üî• Turn red in last 1 hour
      if (remaining <= 60 * 60 * 1000) {
        chatTimer.classList.remove("bg-pink-50", "text-pink-700");
        chatTimer.classList.add("bg-red-100", "text-red-700");
      }
    }, 1000);
  }

  startTimer();
}

  // Safety: block sending after expiry
  chatForm.addEventListener("submit", (e) => {
    if (msgInput.disabled || sendBtn.disabled) {
      e.preventDefault();
      showModal();
    }
  });

</script>
