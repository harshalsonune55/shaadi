<%- layout("/layouts/navbar.ejs") %>

<div class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">

    <div class="flex-1 space-y-6">
      <div class="relative w-full">
        <img src="<%= person.image %>" alt="Profile photo" class="w-full h-80 object-cover rounded-xl shadow-lg" />
        <img
          src="<%= userProfile ? userProfile.image : (user ? (user.fullname ? 'https://ui-avatars.com/api/?name=' + user.fullname.split(' ').join('+') : 'https://ui-avatars.com/api/?name=U') : 'https://ui-avatars.com/api/?name=?') %>"
          alt="Current User Profile"
          class="absolute bottom-4 right-4 w-20 h-20 object-cover rounded-full border-4 border-white shadow-md"
        />
      </div>
      <h1 class="text-3xl font-bold text-gray-900"><%= person.first_name %> <%= person.last_name %></h1>
      <div class="text-gray-600 text-sm"><%= person.address || 'Location not specified' %> ‚Ä¢ Best of the chosen candidate</div>

      <hr class="my-6 border-gray-200">

      <div class="flex flex-wrap gap-4">
        <div class="flex items-start gap-3 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex-1 min-w-[200px]">
          <span class="text-2xl mt-1">‚≠ê</span>
          <div>
            <div class="font-semibold text-gray-800">Guest favourite</div>
            <div class="text-sm text-gray-500">One of the most loved profiles on Shaadiwali.</div>
          </div>
        </div>
        <div class="flex items-center gap-3 bg-white border border-gray-200 rounded-xl p-4 shadow-sm min-w-[150px]">
          <div>
            <div class="font-bold text-lg text-gray-800">4.91</div>
            <div class="text-sm text-gray-500">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ <span class="underline">22 Reviews</span></div>
          </div>
        </div>
      </div>

      <hr class="my-6 border-gray-200">

      <div class="space-y-5">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Highlights</h2>
        <div class="flex gap-4 items-start">
          <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg text-xl flex-shrink-0">üí¨</div>
          <div>
            <p class="font-semibold text-gray-800">Exceptional communication</p>
            <small class="text-gray-500 text-sm">Rated highly for responsiveness and clarity.</small>
          </div>
        </div>
        <div class="flex gap-4 items-start">
          <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg text-xl flex-shrink-0">üíñ</div>
          <div>
            <p class="font-semibold text-gray-800">Highly Recommended</p>
            <small class="text-gray-500 text-sm">95% of recent users recommend this profile.</small>
          </div>
        </div>
        <div class="flex gap-4 items-start">
          <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg text-xl flex-shrink-0">‚úÖ</div>
          <div>
            <p class="font-semibold text-gray-800">Verified Profile</p>
            <small class="text-gray-500 text-sm">Identity and details have been verified.</small>
          </div>
        </div>
      </div>

      <hr class="my-6 border-gray-200">

      <div class="space-y-5">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">About <%= person.first_name %></h2>
        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
          <h3 class="font-semibold text-blue-800 flex items-center gap-2"><span class="text-lg">üßëüèª‚Äçüè´</span> Education:</h3>
          <p class="text-gray-700 mt-1"><%= person.Education || 'Not specified' %></p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
          <h3 class="font-semibold text-green-800 flex items-center gap-2"><span class="text-lg">üíº</span> Work:</h3>
          <p class="text-gray-700 mt-1"><%= person.work || 'Not specified' %></p>
        </div>
        <div class="bg-pink-50 p-4 rounded-lg border-l-4 border-pink-500">
          <h3 class="font-semibold text-pink-800 flex items-center gap-2"><span class="text-lg">üè†</span> Address:</h3>
          <p class="text-gray-700 mt-1"><%= person.address || 'Not specified' %></p>
        </div>

        <!-- <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
          <h3 class="font-semibold text-purple-800 flex items-center gap-2"><span class="text-lg">üì±</span> Phone:</h3>
          <p class="text-gray-700 mt-1"><%= person.phone ? ('+' + person.phone) : 'Not specified' %></p> 
        </div> -->

        <p class="text-gray-700 leading-relaxed pt-2">Enjoy a memorable visit when you stay in this unique place... Self check-in facility is available here. The unit is well-suited for short stays and business travelers.</p>
      </div>
    </div>


    <aside class="w-full lg:w-96 flex-shrink-0">
      <div class="sticky top-8 space-y-6">
        <div class="bg-gradient-to-r from-pink-50 to-red-50 text-red-700 font-semibold px-5 py-3 rounded-xl shadow-md border border-pink-100">üíé Rare find! You have the great choice</div>

        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg space-y-4">

          <% if (user && user._id.toString() !== person._id.toString()) { %>
            <a
              href="/chat/<%= person._id %>"
              class="block w-full text-center py-3 bg-gradient-to-r from-pink-500 to-red-500 
                     text-white font-bold rounded-lg text-lg hover:shadow-xl transition"
            >
              üí¨ Chat Now
            </a>
          <% } else { %>
            <button
              disabled
              class="block w-full text-center py-3 bg-gray-300 text-gray-500 
                     font-bold rounded-lg text-lg cursor-not-allowed"
            >
              This is you
            </button>
          <% } %>
          
   

          <div class="text-center text-gray-500 text-xs">You won't be charged yet</div>

          <% if (!userProfile || !userProfile.isSubscribed) { %>
          <div class="subscription-plans space-y-4 pt-4 border-t border-gray-100">
            <h3 class="font-semibold text-gray-800 text-center">Unlock Premium Features</h3>
            <% ['Basic','Standard','Premium'].forEach((plan) => { %>
            <div class="border rounded-lg p-4 bg-gray-50 space-y-2 hover:bg-gray-100 transition">
              <strong class="block text-gray-800 font-medium"><%= plan %></strong>
              <p class="text-xs text-gray-600">
                <%= plan === 'Basic' ? '‚Çπ499/month ‚Äî Feature A' : plan === 'Standard' ? '‚Çπ999/month ‚Äî Feature A + B' : '‚Çπ2,999/month ‚Äî All Features' %>
              </p>
              <button class="plan-btn w-full py-2 bg-blue-600 text-white rounded-md text-sm font-semibold hover:bg-blue-700 transition">Subscribe</button>
            </div>
            <% }) %>
          </div>
          <% } %>



          <a href="#" id="reportLink" class="text-center block text-gray-500 text-xs hover:underline pt-4">üè≥Ô∏è Report this profile</a>
        </div>
      </div>
    </aside>
  </div>
</div>

<%-include("layouts/footer.ejs") %>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    // --- REMOVED old 'startChatLink' event listener ---

    // Keep the payment button logic ONLY if you still need the subscription plans
    document.querySelectorAll(".plan-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        // Check login using the 'user' variable passed from the server
        if (!<%= user ? true : false %>) {
          alert("Please login first to subscribe!");
          window.location.href = '/login'; // Redirect to login
          return;
        }

        const plan = e.target.parentElement.querySelector("strong").textContent;
        let amount = plan === "Standard" ? 999 : plan === "Premium" ? 2999 : 499;

        try {
          const res = await fetch("/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount }),
          });

          if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
          const data = await res.json();

          const options = {
            key: "<%= process.env.Razor_key_id %>", // Make sure this is available
            amount: amount * 100,
            currency: "INR",
            name: "Shaadiwali Premium Subscription", // Updated name
            description: `${plan} Plan`,
            order_id: data.orderId,
            handler: async function (response) { // Make handler async for verification
              // **Important:** Verify payment on server before confirming subscription
              try {
                  const verifyRes = await fetch('/verify-payment', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          razorpay_order_id: response.razorpay_order_id,
                          razorpay_payment_id: response.razorpay_payment_id,
                          razorpay_signature: response.razorpay_signature
                      })
                  });
                  const verifyData = await verifyRes.json();
                  if (verifyData.success) {
                      alert(`üéâ Payment successful for ${plan} plan! Premium features unlocked.`);
                      // Optionally hide subscription plans after successful payment
                      const plansDiv = document.querySelector('.subscription-plans');
                      if (plansDiv) plansDiv.style.display = 'none';
                      // Reload page to reflect subscription status change
                      window.location.reload();
                  } else {
                      alert(`Payment verification failed: ${verifyData.message || 'Unknown error'}`);
                  }
              } catch (verifyError) {
                   console.error("Error verifying payment:", verifyError);
                   alert("Payment succeeded but verification failed. Please contact support.");
              }
            },
            prefill: {
              // Use logged-in user's details for prefill if available
              name: "<%= user ? user.fullname : (person.first_name + ' ' + person.last_name) %>",
              email: "<%= user ? user.email : person.email %>",
               // Use user's phone if available, otherwise profile owner's (optional)
              contact: "<%= user && user.phone ? user.phone.replace('+','') : (person.phone ? person.phone.replace('+','') : '') %>"
            },
            theme: { color: "#E11D48" },
          };
          const rzp1 = new Razorpay(options);
          rzp1.on('payment.failed', function (response){
                alert("Payment Failed: " + response.error.description);
                console.error('Payment Failed:', response.error);
          });
          rzp1.open();

        } catch (error) {
            console.error("Error during subscription process:", error);
            alert("An error occurred during the subscription process. Please try again.");
        }
      });
    });
</script>

