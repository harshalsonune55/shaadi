<%- layout("layouts/navbar") %>

<div class="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white">

    <div class="min-h-screen bg-gray-900 flex flex-col items-center justify-center text-white">

        <h2 class="text-2xl font-bold mb-2">üìû Voice Call</h2>
      
        <!-- USER IMAGE -->
        <div class="relative mb-4">
          <img
            src="<%= receiver.image || '/default-avatar.png' %>"
            alt="Profile"
            class="w-40 h-40 rounded-full object-cover border-4 border-white shadow-xl"
          />
      
          <!-- Animated Ring -->
          <div class="absolute inset-0 rounded-full border-4 border-green-400 animate-ping"></div>
        </div>
      
        <h3 class="text-xl font-semibold">
          <%= receiver.first_name %> <%= receiver.last_name %>
        </h3>
      
        <p class="text-gray-400 mt-1 mb-6">Voice call in progress...</p>
      
        <!-- CONTROLS -->
        <div class="flex gap-6">
          <button onclick="toggleMute()"
            id="muteBtn"
            class="bg-gray-700 px-6 py-3 rounded-full hover:bg-gray-600 transition">
            üîá Mute
          </button>
      
          <button onclick="endCall()"
            class="bg-red-600 px-6 py-3 rounded-full hover:bg-red-700 transition">
            ‚ùå End Call
          </button>
        </div>
      
      </div>
      
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const roomId = "<%= receiver.phone %>";
const CALL_DURATION = <%= duration %>;


let localStream;
let peerConnection;

const iceServers = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

async function startCall() {

  // üé§ AUDIO ONLY
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  peerConnection = new RTCPeerConnection(iceServers);

  localStream.getTracks().forEach(track =>
    peerConnection.addTrack(track, localStream)
  );

  peerConnection.ontrack = e => {
    const remoteAudio = new Audio();
    remoteAudio.srcObject = e.streams[0];
    remoteAudio.play();
  };

  peerConnection.onicecandidate = e => {
    if (e.candidate) {
      socket.emit("ice_candidate", { roomId, candidate: e.candidate });
    }
  };

  socket.emit("join_call", { roomId });

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  socket.emit("offer", { roomId, offer });
}

socket.on("offer", async offer => {
  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit("answer", { roomId, answer });
});

socket.on("answer", async answer => {
  await peerConnection.setRemoteDescription(answer);
});

socket.on("ice_candidate", async candidate => {
  await peerConnection.addIceCandidate(candidate);
});

socket.on("end_call", () => {
  alert("Call ended");
  window.location.href = "/profile";
});

function endCall() {

if (callTimer) clearInterval(callTimer);

socket.emit("end_call", { roomId });

if (peerConnection) {
  peerConnection.close();
  peerConnection = null;
}

if (localStream) {
  localStream.getTracks().forEach(track => track.stop());
}

window.location.href = "/profile";
}


let isMuted = false;

function toggleMute() {
  localStream.getAudioTracks().forEach(track => {
    track.enabled = isMuted;
  });

  isMuted = !isMuted;
  document.getElementById("muteBtn").innerText =
    isMuted ? "üîä Unmute" : "üîá Mute";
}
let callTimer;
let remainingSeconds;

function startTimer(minutes) {

  remainingSeconds = minutes * 60;

  callTimer = setInterval(() => {

    remainingSeconds--;

    if (remainingSeconds <= 0) {
      clearInterval(callTimer);
      socket.emit("end_call", { roomId });
      endCall();
    }

  }, 1000);
}




async function initCall() {
  await startCall();
  startTimer(CALL_DURATION);
}

initCall();


</script>
